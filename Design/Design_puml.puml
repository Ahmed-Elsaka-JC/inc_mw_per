@startuml NewDesign

' Define color schemes matching original design
skinparam class {
    BackgroundColor<<interface>> LightYellow
    BorderColor<<interface>> DarkGoldenRod
    BackgroundColor<<implementation>> LightBlue
    BorderColor<<implementation>> DodgerBlue
    BackgroundColor<<mock>> LightPink
    BorderColor<<mock>> IndianRed
}

class IKvsBuilder <<implementation>> {
    - instance_id: InstanceId
    - need_defaults : bool
    - need_kvs : bool
    - directory: string
    - OpenedKvs : std::unordered_map<instanceId, std::shared_ptr<kvs> >
    __
    + KvsBuilder(const InstanceId& instance_id)
    + need_defaults_flag(bool flag) : KvsBuilder&
    + need_kvs_flag(bool flag) : KvsBuilder&
    + dir(std::string&& dir_path) : KvsBuilder&
    + backend(IStorageBackend backend) : KvsBuilder&
    + build() : std::shared_ptr<Kvs>
}

IKvsBuilder -[hidden]right- IStorageBackEnd
IStorageBackEnd -[hidden]right- IKvs

' IStorageBackEnd interface (top middle-right)
interface IStorageBackEnd <<interface>> {
    + Load_kvs(instance_id:InstanceId, snapshot_id:SnapshotId):IKvs
    + Load_default(instance_id:InstanceId)
    + Flush(instance_id:InstanceId, kvs:unordered_map<string,kvs>
    + Snapshot_count(instance_id:InstanceId):Result<size_t>
    + Snapshot_restore(instance_id:InstanceId, snapshot_id:SnapshotId) : Kvs
}

' IKvs interface (top right)
interface IKvs <<interface>> {
    + reset()
    + reset_key(string key):Result<bool>
    + get_all_keys() : Result<vector<string>>
    + key_exists(key:string): Result<bool>
    + get_value(key:string) : Result<KvsValue>
    + get_default_value(Key:string) : Result<KvsValue>
    + has_default_value(Key:string) : Result<KvsValue>
    + set_value(Key:string, value:KvsValue): ResultBlank
    + remove_key(Key:string) : ResultBlank
    + flush() : ResultBlank
    + snapshot_count: Result<size_t>
    + snapshot_max_count() : Result<size_t>
    + snapshot_restore(snapshot_id:SnapshotId): ResultBlank
    + get_kvs_file_name(snapshot_id:SnapshotId): Result<filesystem::path>
    + get_hash_filename(snapshot_id:SnapshotId): Result<filesystem::path>
}

IStorageBackEnd_Mock -[hidden]right- JsonBackEnd
JsonBackEnd -[hidden]right- IKvs_mock
IKvs_mock -[hidden]right- Kvs

' IStorageBackEnd_Mock (middle left)
class IStorageBackEnd_Mock <<mock>> {
    + Load_kvs(instance_id:InstanceId, snapshot_id:SnapshotId):Kvs
    + Load_default(instance_id:InstanceId)
    + Flush(instance_id:InstanceId, kvs:unordered_map<string,kvs>
    + Snapshot_count(instance_id:InstanceId):Result<size_t>
    + Snapshot_restore(instance_id:InstanceId, snapshot_id:SnapshotId) : Kvs
    + get_kvs_file_name(snapshot_id:SnapshotId): Result<filesystem::path>
    + get_hash_filename(snapshot_id:SnapshotId): Result<filesystem::path>
}

' JsonBackEnd (middle right)
class JsonBackEnd <<implementation>> {
    - Instance_id: InstanceId
    __
    + Load_kvs(instance_id:InstanceId, snapshot_id:SnapshotId):IKvs
    + Load_default(instance_id:InstanceId)
    + Flush(instance_id:InstanceId, kvs:unordered_map<string,kvs>
    + Snapshot_count(instance_id:InstanceId):Result<size_t>
    + Snapshot_restore(instance_id:InstanceId, snapshot_id:SnapshotId) : Kvs
    + **get_kvs_file_name(snapshot_id:SnapshotId): Result<filesystem::path>**
    + **get_hash_filename(snapshot_id:SnapshotId): Result<filesystem::path>**
}

' IKvs_mock (bottom middle-left)
class IKvs_mock <<mock>> {
    + reset()
    + reset_key(string key):Result<bool>
    + get_all_keys() : Result<vector<string>>
    + key_exists(key:string): Result<bool>
    + get_value(key:string) : Result<KvsValue>
    + get_default_value(Key:string) : Result<KvsValue>
    + has_default_value(Key:string) : Result<KvsValue>
    + set_value(Key:string, value:KvsValue): ResultBlank
    + remove_key(Key:string) : ResultBlank
    + flush() : ResultBlank
    + snapshot_count: Result<size_t>
    + snapshot_max_count() : Result<size_t>
    + snapshot_restore(snapshot_id:SnapshotId): ResultBlank
    + get_kvs_file_name(snapshot_id:SnapshotId): Result<filesystem::path>
    + get_hash_filename(snapshot_id:SnapshotId): Result<filesystem::path>
}

' Kvs (bottom right)
class Kvs <<implementation>> {
    + kvs : unordered_map<string, KvsValue>
    + default_kvs : unordered_map<string, KvsValue>
    + filename_prefix : score::filesystem::path
    + filesystem : score::filesystem
    + parser : unique_ptr<IjsonParser> parser
    + writer : unique_ptr<IjsonWriter> writer
    + logger : unique_ptr<mw::log::logger> logger
    + Storage_backend : IStorageBackEnd
    __
    + reset()
    + reset_key(string key):Result<bool>
    + get_all_keys() : Result<vector<string>>
    + key_exists(key:string): Result<bool>
    + get_value(key:string) : Result<KvsValue>
    + get_default_value(Key:string) : Result<KvsValue>
    + has_default_value(Key:string) : Result<KvsValue>
    + set_value(Key:string, value:KvsValue): ResultBlank
    + remove_key(Key:string) : ResultBlank
    + flush() : ResultBlank
    + snapshot_count: Result<size_t>
    + snapshot_max_count() : Result<size_t>
    + snapshot_restore(snapshot_id:SnapshotId): ResultBlank
    + get_kvs_file_name(snapshot_id:SnapshotId): Result<filesystem::path>
    + get_hash_filename(snapshot_id:SnapshotId): Result<filesystem::path>
}

' Relationships
IStorageBackEnd_Mock -up-|> IStorageBackEnd : implements
JsonBackEnd -up-|> IStorageBackEnd : implements
IKvs_mock -up-|> IKvs : implements
Kvs -up-|> IKvs : implements

' Dependencies
IKvsBuilder ..> IStorageBackEnd : uses
IKvsBuilder ..> IKvs : uses
IStorageBackEnd o-- IKvs : aggregates

' Notes matching original design
note left of IKvsBuilder
    builder will contain static map for opened instances
    single tone should be applied to the builder
    builder should contains cached opened KVSs
end note

note right of IKvsBuilder
    by default json backend is used but other backends
    can be implemented and passed to the builder through
    **backend()** method
end note

@enduml
